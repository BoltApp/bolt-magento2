version: 2
jobs:
  wip-test:
    docker:
      - image: boltdev/m2-plugin-ci-php72:v2-ethan
      - image: circleci/mysql:5.7
    steps:
      - checkout
      - run:
          name: Install nginx
          command: |
            apt get -y install nginx php7.2-fpm php7.2-cli
      - restore_cache:
          keys:
            - v2-ethan-php72mag23-composer-lock-{{ arch }}-{{ checksum "composer.json" }}
            - v2-ethan-php72mag23-composer-lock-{{ arch }}
            - v2-ethan-php72mag23-composer-lock
      - run:
          name: PHP 7.2 Magento2.3
          command: |
            mkdir ./artifacts
            export TEST_ENV=php72
            MAGENTO_VERSION=2.3.0 Test/scripts/ci.sh
      - save_cache:
          key: v2-ethan-php72mag23-composer-lock-{{ arch }}-{{ checksum "composer.json" }}
          paths:
            - /home/circleci/.composer/cache/
      - store_artifacts:
          path: ./artifacts

workflows:
  version: 2
  build:
    jobs:
      - wip-test