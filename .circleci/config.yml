version: 2
jobs:
  integration-php72-magento23:
    docker:
      - image: boltdev/m2-installed-plugin-ci-php72:2.3.0-v2
        auth:
          username: $DOCKERHUB_USER
          password: $DOCKERHUB_PASS
    environment:
        MAGENTO_DIR: magento
    steps:
      - checkout
      - restore_cache:
          keys:
            - 2.3.0-v1-php72mag23installed-composer-lock-{{ arch }}-{{ checksum "composer.json" }}
            - 2.3.0-v1-php72mag23installed-composer-lock-{{ arch }}
            - 2.3.0-v1-php72mag23installed-composer-lock
      - run:
          name: PHP 7.2 Magento2.3
          command: |
            mkdir ./artifacts
            export TEST_ENV=php72
            MAGENTO_VERSION=2.3.0 Test/scripts/ci-integration.sh
      - save_cache:
          key: 2.3.0-v1-php72mag23installed-lock-{{ arch }}-{{ checksum "composer.json" }}
          paths:
            - /home/circleci/.composer/cache/
      - store_artifacts:
          path: ./artifacts

  unit-php72-magento23:
    docker:
      - image: boltdev/m2-installed-plugin-ci-php72:2.3.0-v1
        auth:
          username: $DOCKERHUB_USER
          password: $DOCKERHUB_PASS
      - image: circleci/mysql:5.7
    steps:
      - checkout
      - restore_cache:
          keys:
            - 2.3.0-v1-php72mag23installed-composer-lock-{{ arch }}-{{ checksum "composer.json" }}
            - 2.3.0-v1-php72mag23installed-composer-lock-{{ arch }}
            - 2.3.0-v1-php72mag23installed-composer-lock
      - run:
          name: PHP 7.2 Magento2.3
          command: |
            mkdir ./artifacts
            export TEST_ENV=php72
            MAGENTO_VERSION=2.3.0 Test/scripts/ci-unit.sh
      - save_cache:
          key: 2.3.0-v1-php72mag23installed-lock-{{ arch }}-{{ checksum "composer.json" }}
          paths:
            - /home/circleci/.composer/cache/
      - store_artifacts:
          path: ./artifacts

  unit-php71-magento22:
    docker:
      - image: boltdev/m2-installed-plugin-ci-php71:2.2.0-v1
        auth:
          username: $DOCKERHUB_USER
          password: $DOCKERHUB_PASS
      - image: circleci/mysql:5.7
    steps:
      - checkout
      - restore_cache:
          keys:
            - 2.2.0-v1-php71mag22installed-composer-lock-{{ arch }}-{{ checksum "composer.json" }}
            - 2.2.0-v1-php71mag22installed-composer-lock-{{ arch }}
            - 2.2.0-v1-php71mag22installed-composer-lock
      - run:
          name: PHP 7.1 Magento2.2
          command: |
            mkdir ./artifacts
            export TEST_ENV=php71
            MAGENTO_VERSION=2.2.0 Test/scripts/ci-unit.sh
      - save_cache:
          key: v1-php71mag22-composer-lock-{{ arch }}-{{ checksum "composer.json" }}
          paths:
            - /home/circleci/.composer/cache/
      - store_artifacts:
          path: ./artifacts

  unit-php70-magento22:
    docker:
      - image: boltdev/m2-installed-plugin-ci-php70:2.2.0-v1
        auth:
            username: $DOCKERHUB_USER
            password: $DOCKERHUB_PASS
      - image: circleci/mysql:5.7
    steps:
      - checkout
      - restore_cache:
          keys:
            - 2.2.0-v1-php70mag22installed-composer-lock-{{ arch }}-{{ checksum "composer.json" }}
            - 2.2.0-v1-php70mag22installed-composer-lock-{{ arch }}
            - 2.2.0-v1-php70mag22installed-composer-lock
      - run:
          name: PHP 7.0 Magento2.2
          command: |
            mkdir ./artifacts
            export TEST_ENV=php70
            MAGENTO_VERSION=2.2.0 Test/scripts/ci-unit.sh
      - save_cache:
          key: 2.2.0-v1-php70mag22installed-composer-lock-{{ arch }}-{{ checksum "composer.json" }}
          paths:
            - /home/circleci/.composer/cache/
      - store_artifacts:
          path: ./artifacts

  phpcs:
    docker:
      - image: circleci/php:7.2-cli
    steps:
      - checkout
      - run:
          name: phpcs MEQP2 standard test
          command: |
            Test/scripts/phpcs_meqp2.sh


workflows:
  version: 2
  build:
    jobs:
      - phpcs
      - unit-php72-magento23
      - unit-php71-magento22
      - unit-php70-magento22
      - integration-php72-magento23
