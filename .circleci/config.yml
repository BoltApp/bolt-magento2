version: 2.1

orbs:
  slack: circleci/slack@3.3.0
  swissknife: roopakv/swissknife@0.25.0

commands:
  notify-rc-tag:
    description: 'Notifies #eng-magento2 when a release candidate is tagged.'
    parameters:
      tag-name:
        type: string
        default: ''
    steps:
    - slack/notify:
        only_for_branches: master
        color: '#33ff00'
        mentions: '@oleksii,@Pavel,'
        message: ":white_check_mark: A new RC << parameters.tag-name >> has been tagged for Magento 2!"
        webhook: $SLACK_MAGENTO2_WEBHOOK

  m2-php-test:
    description: PHP Unit tests for M2
    parameters:
      cache_key_separator:
        type: string
      m2_version:
        type: enum
        default: "2.3.0"
        enum: ["2.2.0", "2.3.0"]
      php_version:
        type: enum
        default: "php72"
        enum: ["php70", "php71", "php72"]
      is_integration:
        type: boolean
        default: false
    steps:
      - checkout
      - restore_cache:
          keys:
            - << parameters.m2_version >>-v1-<< parameters.cache_key_separator >>-composer-lock-{{ arch }}-{{ checksum "composer.json" }}
            - << parameters.m2_version >>-v1-<< parameters.cache_key_separator >>-composer-lock-{{ arch }}
            - << parameters.m2_version >>-v1-<< parameters.cache_key_separator >>-composer-lock
      - when:
          condition: << parameters.is_integration >>
          steps:
            - run:
                name: << parameters.php_version >> Magento << parameters.m2_version >> Integration
                command: |
                  mkdir ./artifacts
                  export TEST_ENV=<< parameters.php_version >>
                  MAGENTO_VERSION=<< parameters.m2_version >> Test/scripts/ci-integration.sh
      - unless:
          condition: << parameters.is_integration >>
          steps:
            - run:
                name: << parameters.php_version >> << parameters.m2_version >> Unit
                command: |
                  mkdir ./artifacts
                  export COMPOSER_MEMORY_LIMIT=3G
                  export TEST_ENV=<< parameters.php_version >>
                  MAGENTO_VERSION=<< parameters.m2_version >> Test/scripts/ci-unit.sh
      - save_cache:
          key: << parameters.m2_version >>-v1-<< parameters.cache_key_separator >>-lock-{{ arch }}-{{ checksum "composer.json" }}
          paths:
            - /home/circleci/.composer/cache/
      - store_artifacts:
          path: ./artifacts
      - slack/status:
          fail_only: true
          failure_message: ':red_circle: M2: A $CIRCLE_JOB job has failed!'
          only_for_branches: master
          webhook: $SLACK_GREENKEEPER_WEBHOOK

jobs:
  tag-rc-candidate:
    description: Tag master as rc every 3 weeks
    docker:
    - image: boltdev/m2-installed-plugin-ci-php72:2.3.0-v2
      auth:
        username: $DOCKERHUB_USER
        password: $DOCKERHUB_PASS
    environment:
      MAGENTO_DIR: magento
    steps:
      - run: |
          .circleci/scripts/rc-tag.sh
      - when:
          condition: $TAGTHISWEEK
          steps:
            - run:
                command: |
                  apt-get update
                  apt-get install -y git
                  apt-get install -y openssh-server
            - swissknife/publish_github_release:
              tag: $NEWTAGNAME
            - notify-rc-tag:
              tag: $NEWTAGNAME

  integration-php72-magento23:
    docker:
      - image: boltdev/m2-installed-plugin-ci-php72:2.3.0-v2
        auth:
          username: $DOCKERHUB_USER
          password: $DOCKERHUB_PASS
    environment:
        MAGENTO_DIR: magento
    steps:
      - m2-php-test:
          cache_key_separator: php72mag23installed
          m2_version: "2.3.0"
          php_version: "php72"
          is_integration: true

  unit-php72-magento23:
    docker:
      - image: boltdev/m2-installed-plugin-ci-php72:2.3.0-v1
        auth:
          username: $DOCKERHUB_USER
          password: $DOCKERHUB_PASS
      - image: circleci/mysql:5.7
    steps:
      - m2-php-test:
          cache_key_separator: php72mag23installed
          m2_version: "2.3.0"
          php_version: "php72"
          is_integration: false

  unit-php71-magento22:
    docker:
      - image: boltdev/m2-installed-plugin-ci-php71:2.2.0-v1
        auth:
          username: $DOCKERHUB_USER
          password: $DOCKERHUB_PASS
      - image: circleci/mysql:5.7
    steps:
      - m2-php-test:
          cache_key_separator: php71mag22installed
          m2_version: "2.2.0"
          php_version: "php71"
          is_integration: false

  unit-php70-magento22:
    docker:
      - image: boltdev/m2-installed-plugin-ci-php70:2.2.0-v1
        auth:
            username: $DOCKERHUB_USER
            password: $DOCKERHUB_PASS
      - image: circleci/mysql:5.7
    steps:
      - m2-php-test:
          cache_key_separator: php70mag22installed
          m2_version: "2.2.0"
          php_version: "php70"
          is_integration: false

  phpcs:
    docker:
      - image: circleci/php:7.2-cli
    steps:
      - checkout
      - run:
          name: phpcs MEQP2 standard test
          command: |
            Test/scripts/phpcs_meqp2.sh


workflows:
  version: 2
  build:
    jobs:
      - phpcs
      - unit-php72-magento23
      - unit-php71-magento22
      - unit-php70-magento22
      - integration-php72-magento23
  tagger:
    triggers:
      - schedule:
          cron: "0 5 * * 5"
          filters:
            branches:
              only:
                - master
    jobs:
      - tag-rc-candidate